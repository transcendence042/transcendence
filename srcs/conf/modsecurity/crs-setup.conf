# -----------------------------------------------------------------------------
# OWASP CRS setup overrides (lightweight tuning starting point)
# -----------------------------------------------------------------------------

# Paranoia Level:
# 1 = safe defaults, 2/3/4 = more strict (more FPs to tune)
SecAction \
 "id:900000,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.paranoia_level=1,\
  setvar:tx.executing_paranoia_level=1"

# Treat static assets in DetectionOnly mode
SecAction \
 "id:900100,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.static_assets_detectiononly=1"

# Inbound / Outbound Anomaly thresholds:
# Block when score >= threshold. Lower = stricter (more blocking).
SecAction \
 "id:900110,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score_threshold=5,\
  setvar:tx.outbound_anomaly_score_threshold=4"
  
# Health checks and CORS preflights
SecAction \
 "id:900120,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.allow_static_path=/static/"

SecAction \
 "id:900121,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.allow_healthz=1"

SecAction \
 "id:900122,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.allow_ping=1"

SecAction \
 "id:900123,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.allow_cors_preflight=1"

# Enforce JSON and XML processors (ModSec body parsers already enabled in modsecurity.conf)
SecAction \
 "id:900200,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.crs_exclusions_json=1,\
  setvar:tx.crs_exclusions_xml=1"

# Enforce API Content-Type rules
SecAction \
 "id:900210,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.api_enforce_content_type=1"

SecAction \
 "id:900211,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.api_upload_allow_multipart=1"

# Allowed content types (tighten if you like; keep in sync with optional POST rule you may enable)
SecAction \
 "id:900220,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded|multipart/form-data|application/json|text/xml|application/xml|'"

# File extensions and request limits (tune to your app)
SecAction \
 "id:900230,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.max_num_args=256,\
  setvar:tx.arg_name_length=50,\
  setvar:tx.arg_length=64000,\
  setvar:tx.total_arg_length=64000,\
  setvar:tx.max_file_size=12000000,\
  setvar:tx.combined_file_sizes=12000000"

# Allowed HTTP methods for CRS (align with your custom allow-list in modsecurity.conf)
SecAction \
 "id:900300,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST'"

# Login rate limiting switches
SecAction \
 "id:900400,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.login_ratelimit_enabled=1"

SecAction \
 "id:900401,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.login_ratelimit_window=60"

SecAction \
 "id:900402,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.login_ratelimit_maxreq=10"

SecAction \
 "id:900403,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.login_fail_tracking=1"

# CSRF protection toggles
SecAction \
 "id:900500,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.csrf_token_required=1"

SecAction \
 "id:900501,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.csrf_auth_exceptions=/api/auth/"

# Canary flag to confirm ModSecurity is active
SecAction \
 "id:999999,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.demo_block_keyword=malicious"