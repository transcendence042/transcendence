# -----------------------------------------------------------------------------
# OWASP CRS setup overrides (lightweight tuning starting point)
# -----------------------------------------------------------------------------

# Paranoia Level:
# 1 = safe defaults, 2/3/4 = more strict (more FPs to tune)
SecAction \
 "id:800000,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.paranoia_level=1,\
  setvar:tx.executing_paranoia_level=1"

# Treat static assets in DetectionOnly mode
SecAction \
 "id:800100,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.static_assets_detectiononly=1"

# Inbound / Outbound Anomaly thresholds:
# Block when score >= threshold. Lower = stricter (more blocking).
SecAction \
 "id:800110,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score_threshold=5,\
  setvar:tx.outbound_anomaly_score_threshold=4"
  
# Health checks and CORS preflights
SecAction \
 "id:800120,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.allow_static_path=/static/"

SecAction \
 "id:800121,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.allow_healthz=1"

SecAction \
 "id:800122,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.allow_ping=1"

SecAction \
 "id:800123,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.allow_cors_preflight=1"

# Enforce JSON and XML processors (ModSec body parsers already enabled in modsecurity.conf)
SecAction \
 "id:800200,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.crs_exclusions_json=1,\
  setvar:tx.crs_exclusions_xml=1"

# Enforce API Content-Type rules
SecAction \
 "id:800210,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.api_enforce_content_type=1"

SecAction \
 "id:800211,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.api_upload_allow_multipart=1"

# Allowed content types (tighten if you like; keep in sync with optional POST rule you may enable)
SecAction \
 "id:800220,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded|multipart/form-data|application/json|text/xml|application/xml|'"

# File extensions and request limits (tune to your app)
SecAction \
 "id:800230,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.max_num_args=256,\
  setvar:tx.arg_name_length=50,\
  setvar:tx.arg_length=64000,\
  setvar:tx.total_arg_length=64000,\
  setvar:tx.max_file_size=12000000,\
  setvar:tx.combined_file_sizes=12000000"

# Allowed HTTP methods for CRS (align with your custom allow-list in modsecurity.conf)
SecAction \
 "id:800300,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST'"

# Login rate limiting switches
SecAction \
 "id:800400,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.login_ratelimit_enabled=1"

SecAction \
 "id:800401,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.login_ratelimit_window=60"

SecAction \
 "id:800402,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.login_ratelimit_maxreq=10"

SecAction \
 "id:800403,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.login_fail_tracking=1"

# CSRF protection toggles
SecAction \
 "id:800500,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.csrf_token_required=1"

SecAction \
 "id:800501,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.csrf_auth_exceptions=/api/auth/"

# Allowed hostnames for Host header validation (edit this list!)
SecAction \
 "id:800700,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_hostnames=example\\.com|api\\.example\\.com|localhost'"

# Allowed POST content-types (used by the strict POST CT rule below)
SecAction \
 "id:800701,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_post_ct=application/x-www-form-urlencoded|multipart/form-data|application/json'"

# RFC1918/localhost/metadata IPs (used by the SSRF rule below)
SecAction \
 "id:800702,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.private_ip_regex=127\\.0\\.0\\.1|0\\.0\\.0\\.0|10\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}|192\\.168\\.[0-9]{1,3}\\.[0-9]{1,3}|172\\.(?:1[6-9]|2[0-9]|3[0-1])\\.[0-9]{1,3}\\.[0-9]{1,3}|169\\.254\\.169\\.254'"

# Suspicious URL schemes often used for SSRF/LFI gadgets
SecAction \
 "id:800703,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.bad_schemes=file|gopher|dict|smb|jar|php|expect|data'"

# LFI target paths (quick wins)
SecAction \
 "id:800704,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.lfi_paths=(?:^|/)(?:etc/passwd|shadow|hosts)(?:$|[^a-z])'"

# Canary flag to confirm ModSecurity is active
SecAction \
 "id:899999,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.demo_block_keyword=malicious"