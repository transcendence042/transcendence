# Initialize collection by IP
SecAction "id:900400,phase:1,pass,nolog,initcol:ip=%{REMOTE_ADDR}"

# Count attempts to /api/login by IP (60s window)
SecRule REQUEST_URI "^/api/login" \
    "id:900401,phase:1,pass,nolog,setvar:ip.login_rate=+1,expirevar:ip.login_rate=60"

# Block if exceeds 10 req/min to /api/login
SecRule IP:login_rate "@gt 10" \
    "id:900402,phase:1,deny,status:429,log,msg:'Too many login attempts per minute'"

# (Optional) If you detect login failure due to 401/403 response, increment a stricter counter:
SecRule RESPONSE_STATUS "^401|403$" "id:900403,phase:5,pass,nolog,setvar:ip.login_fail=+1,expirevar:ip.login_fail=600"
SecRule IP:login_fail "@gt 20" "id:900404,phase:1,deny,status:429,log,msg:'Too many failed logins (10 min)'"
