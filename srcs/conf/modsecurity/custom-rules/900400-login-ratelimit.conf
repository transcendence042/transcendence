SecAction "id:900400,phase:1,pass,nolog,initcol:ip=%{REMOTE_ADDR}"

SecRule REQUEST_URI "@beginsWith /api/login" \
  "id:900401,phase:1,pass,nolog,chain"
  SecRule REQUEST_METHOD "POST" "t:none,chain"
  SecRule &ARGS "@ge 0" "setvar:ip.login_rate=+1,expirevar:ip.login_rate=60"

SecRule IP:login_rate "@gt 10" \
  "id:900402,phase:1,deny,status:429,log,msg:'Too many login attempts per minute'"

# Optional: failed login tracker (10 min)
SecRule REQUEST_URI "@beginsWith /api/login" "id:900403,phase:5,pass,nolog,chain"
  SecRule RESPONSE_STATUS "@rx ^(?:401|403)$" "setvar:ip.login_fail=+1,expirevar:ip.login_fail=600"

SecRule IP:login_fail "@gt 20" \
  "id:900404,phase:1,deny,status:429,log,msg:'Too many failed logins (10 min)'"
