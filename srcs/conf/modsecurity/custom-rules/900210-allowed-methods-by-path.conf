# 900210 - Allowed methods by path (defaults + per-endpoint overrides)
#
# These rules enforce allowed HTTP methods per path:
# - Only GET/HEAD are allowed on the root path (/).
# - By default, only GET/HEAD/POST are allowed on /api/ endpoints.
# - For /api/profiles and /api/items, PUT and DELETE are also allowed.
# - You can override allowed methods per endpoint as needed.
#
# This helps prevent misuse of HTTP methods and reduces attack surface.

# Only GET/HEAD in root (SPA frontend)
SecRule REQUEST_URI "^/$" "id:900211,phase:1,deny,status:405,t:none,chain,msg:'Method not allowed in /'"
SecRule REQUEST_METHOD "!@within %{tx.allowed_methods_root}"

# In /api/ only GET/HEAD/POST by default
SecRule REQUEST_URI "@beginsWith /api/" "id:900212,phase:1,deny,status:405,t:none,chain,msg:'Method not allowed in /api/'"
SecRule REQUEST_METHOD "!@within %{tx.allowed_methods_api}"

# OVERRIDES per endpoint

# /api/profiles - also allow PUT and DELETE
SecRule REQUEST_URI "^/api/profiles$" "id:900213,phase:1,pass,ctl:ruleRemoveTargetById=900212;REQUEST_METHOD"
SecRule REQUEST_URI "^/api/profiles$" "id:900214,phase:1,deny,status:405,t:none,chain,msg:'Method not allowed on /api/profiles'"
SecRule REQUEST_METHOD "!@within %{tx.allowed_methods_profiles}"

# /api/items and /api/items/{id} - allow PUT/DELETE
SecRule REQUEST_URI "^/api/items(?:/\d+)?$" "id:900215,phase:1,pass,ctl:ruleRemoveTargetById=900212;REQUEST_METHOD"
SecRule REQUEST_URI "^/api/items(?:/\d+)?$" "id:900216,phase:1,deny,status:405,t:none,chain,msg:'Method not allowed on /api/items'"
SecRule REQUEST_METHOD "!@within %{tx.allowed_methods_items}"

# If any endpoint requires PATCH, add PATCH to the method regex for that route.
