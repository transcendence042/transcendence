# Require X-CSRF-Token on state-changing methods under /api/
SecRule REQUEST_METHOD "@rx ^(?:POST|PUT|PATCH|DELETE)$" \
  "id:900500,phase:2,deny,status:403,log,msg:'CSRF token missing',chain"
  SecRule REQUEST_URI "@beginsWith /api/" "t:none,chain"
  SecRule &REQUEST_HEADERS:X-CSRF-Token "@eq 0"

# Exclude auth endpoints if they legitimately lack the token
SecRule REQUEST_URI "^/api/auth/(?:login|refresh|callback)" \
  "id:900501,phase:1,pass,nolog,ctl:ruleRemoveById=900500"
