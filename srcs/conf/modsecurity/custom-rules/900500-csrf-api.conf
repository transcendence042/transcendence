# Require X-CSRF-Token header on methods that change state
SecRule REQUEST_METHOD "@rx ^(?:POST|PUT|PATCH|DELETE)$" \
"id:900500,phase:2,deny,status:403,log,msg:'CSRF token missing',chain"
SecRule REQUEST_URI "@beginsWith /api/" "t:none,chain"
SecRule &REQUEST_HEADERS:X-CSRF-Token "@eq 0"

# Exclude authentication routes if they don't use a token (adjust your own)
SecRule REQUEST_URI "^/api/auth/(?:login|refresh|callback)" \ 
"id:900501,phase:1,pass,nolog,ctl:ruleRemoveById=900500"