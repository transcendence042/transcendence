# Apply relaxations / toggles based on TX variables you set in crs-setup.conf
# Requires the SecAction ids 800120–800123, 800210–211 to exist.

# --- Allow static path in DetectionOnly (e.g., /static/) ---
SecRule TX:allow_static_path "@rx .+" \
  "id:900840,phase:1,pass,nolog,chain"
  SecRule REQUEST_URI "@beginsWith %{tx.allow_static_path}" \
    "t:none,ctl:ruleEngine=DetectionOnly,log,pass,msg:'Static path in DetectionOnly'"

# --- Health check allow (e.g., /healthz) ---
SecRule TX:allow_healthz "@eq 1" \
  "id:900841,phase:1,pass,nolog,chain"
  SecRule REQUEST_URI "@rx ^/(?:healthz|health|live|ready)$" \
    "t:none,ctl:ruleEngine=DetectionOnly,log,pass,msg:'Health check path in DetectionOnly'"

# --- Simple ping allow (GET /ping) ---
SecRule TX:allow_ping "@eq 1" \
  "id:900842,phase:1,pass,nolog,chain"
  SecRule REQUEST_URI "@rx ^/ping$" \
    "t:none,ctl:ruleEngine=DetectionOnly,log,pass,msg:'Ping path in DetectionOnly'"

# --- CORS preflight relax ---
SecRule TX:allow_cors_preflight "@eq 1" \
  "id:900843,phase:1,pass,nolog,chain"
  SecRule REQUEST_METHOD "OPTIONS" \
    "t:none,chain"
    SecRule REQUEST_HEADERS:Access-Control-Request-Method "@rx .+" \
      "t:none,ctl:ruleEngine=DetectionOnly,log,pass,msg:'CORS preflight in DetectionOnly'"

# --- Enforce API Content-Type (if you want strict CT for POST/PUT/PATCH) ---
# Uses your tx.api_enforce_content_type and tx.allowed_request_content_type
SecRule TX:api_enforce_content_type "@eq 1" \
  "id:900844,phase:1,pass,nolog,chain"
  SecRule REQUEST_METHOD "(?:POST|PUT|PATCH)" \
    "t:none,chain"
    SecRule REQUEST_HEADERS:Content-Type "!@rx ^(?:%{tx.allowed_request_content_type})(?:;|$)" \
      "t:none,deny,log,status:415,msg:'Unsupported Content-Type for API write methods'"

# --- (Optional) Tighten uploads to multipart only when api_upload_allow_multipart=1 ---
SecRule TX:api_upload_allow_multipart "@eq 1" \
  "id:900845,phase:1,pass,nolog,chain"
  SecRule REQUEST_METHOD "POST" \
    "t:none,chain"
    SecRule REQUEST_HEADERS:Content-Type "!@rx ^multipart/form-data(?:;|$)" \
      "t:none,deny,log,status:415,msg:'Only multipart/form-data allowed for uploads (toggle)'"
