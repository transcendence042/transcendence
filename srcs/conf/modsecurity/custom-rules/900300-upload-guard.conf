# Block dangerous extensions in filenames (multipart)
SecRule FILES_NAMES "@rx (?i)\.(?:php\d?|phtml|phar|exe|dll|jsp|asp|aspx|sh|bat|cmd|com|js)$" \
  "id:900300,phase:2,deny,status:403,msg:'Dangerous file extension on upload'"

# Block double extensions (e.g. image.jpg.php)
SecRule FILES_NAMES "@rx (?i)\.(?:jpe?g|png|gif|svg|webp)\.(?:php\d?|phtml|phar|exe|js|jsp|asp|aspx)$" \
  "id:900301,phase:2,deny,status:403,msg:'Double extension on upload'"

# Enforce multipart/form-data on /api/upload
SecRule REQUEST_URI "@beginsWith /api/upload" \
  "id:900302,phase:1,deny,status:415,log,chain,msg:'Only multipart in /api/upload'"
  SecRule REQUEST_HEADERS:Content-Type "!@rx ^multipart/form-data(?:;|$)" "t:none"

# Specific size limit for /api/upload (8 MB)
SecRule REQUEST_URI "@beginsWith /api/upload" \
  "id:900303,phase:2,deny,status:413,log,chain,msg:'Upload too large in /api/upload'"
  SecRule REQUEST_BODY_LENGTH "@gt 8000000"
